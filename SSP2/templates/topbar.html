{% load static %}

<style>
/* NAVBAR (unchanged) */
.navbar {
    padding: 10px 20px;
    display: flex;
    justify-content: flex-end;
    align-items: center;
}

#notifBtn {
   background: none;
   border: none;
   color: #ffffff;
   font-size: 1.375rem;
   cursor: pointer;
   position: relative;
   transition: all 0.2s ease;
   padding: 0.5rem;
   border-radius: 8px;
}

#notifBtn:hover {
   background: rgba(255, 255, 255, 0.1);
   transform: scale(1.1);
}

/* Shows only unseen notification count */
#notifCount {
    background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
    color: white;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.125rem 0.375rem;
    border-radius: 999px;
    min-width: 1.125rem;
    text-align: center;
    position: absolute;
    top: -0.25rem;
    right: -0.5rem;
    display: none; /* Hidden by default */
    box-shadow: 0 2px 8px rgba(245, 101, 101, 0.4);
}

/* NOTIFICATION PANEL (enhanced styling) */
#notifPanel {
    width: 400px;
    max-height: 450px;
    background: #ffffff;
    border-radius: 16px;
    border: 1px solid #e2e8f0;
    padding: 0;
    display: none;
    position: absolute;
    top: 60px;
    right: 15px;
    z-index: 2000;

    transform-origin: top right;
    transform: scale(0.95);
    opacity: 0;
    transition: all 0.2s ease-out;

    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
}

#notifPanel.open {
    transform: scale(1);
    opacity: 1;
}

/* PANEL HEADER */
#notifHeader {
    font-weight: 600;
    padding: 1rem 1.25rem;
    border-bottom: none;
    font-size: 1rem;
    color: #ffffff;
    background: linear-gradient(135deg, #2a7a9f 0%, #1f5f7f 100%);
    border-radius: 16px 16px 0 0;
}

/* LIST AREA WITH UPDATED SCROLLBAR COLORS */
#notifList {
    max-height: 380px;
    overflow-y: auto;
}

/* CUSTOM SCROLLBAR â€” UPDATED AS YOU REQUESTED */
#notifList::-webkit-scrollbar {
    width: 7px;
}

#notifList::-webkit-scrollbar-track {
    background: #e6e9ef;     /* Same track */
    border-radius: 10px;
}

#notifList::-webkit-scrollbar-thumb {
    background: #5a5f66;     /* New darker slider */
    border-radius: 10px;
}

#notifList::-webkit-scrollbar-thumb:hover {
    background: #3e4247;     /* Hover shade */
}

/* INDIVIDUAL NOTIFICATION ITEM (enhanced) */
.notification-item {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.2s ease;
}

.notification-item:hover,
.notification-item:focus {
    background: #f7fafc;
    transform: translateX(2px);
}

.notification-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: #1a202c;
    font-size: 0.95rem;
}

.notification-item div {
    color: #2d3748;
    font-size: 0.9rem;
}

.timestamp {
    margin-top: 0.5rem;
    font-size: 0.75rem;
    color: #718096;
    font-weight: 500;
}

/* RESPONSIVE */
@media (max-width: 600px) {
    #notifPanel {
        width: auto;
        left: 10px;
        right: 10px;
        border-radius: 10px;
    }
}
</style>



<!-- NAVBAR HTML -->
<nav class="navbar navbar-dark navbar-expand-lg navbar-custom fixed-top">

    <button class="toggle-btn" onclick="toggleSidebar()">
        <i class="fa fa-bars"></i>
    </button>

    <div class="ms-auto profile-area">

        <!-- NOTIFICATION BELL -->
        <button id="notifBtn" aria-haspopup="true" aria-expanded="false" aria-controls="notifPanel">
            ðŸ””
            <span id="notifCount">0</span>
        </button>

        <!-- PANEL -->
        <div id="notifPanel" tabindex="-1">
            <div id="notifHeader">Notifications</div>
            <div id="notifList"></div>
        </div>

        <span>Admin</span>

        {% if session %}
            <img src="/photo/{{ session }}" class="rounded-circle" alt="Profile">
        {% else %}
            <img src="{% static 'images/default.png' %}" class="rounded-circle" alt="Default">
        {% endif %}

        <a href="/logout" class="btn btn-danger btn-sm">
            <i class="fa fa-sign-out-alt"></i>
        </a>

    </div>
</nav>




<script>
/* TIME FORMATTER -> Returns human-readable time (5m, 3h, etc.) */
const timeAgo = (timestamp) => {
    const diff = (new Date() - new Date(timestamp)) / 1000;

    if (diff < 60) return `${Math.floor(diff)}s`;
    if (diff < 3600) return `${Math.floor(diff / 60)}m`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h`;
    return `${Math.floor(diff / 86400)}d`;
};



/* RENDER A SINGLE NOTIFICATION BLOCK */
function renderNotification({ id, title, message, createdAt, read }) {

    const item = document.createElement("div");
    item.className = "notification-item";
    item.tabIndex = 0;
    item.dataset.id = id;

    // Dim already-read notifications
    if (read) item.style.opacity = "0.5";

    item.innerHTML = `
        <div class="notification-title">${title}</div>
        <div>${message}</div>
        <div class="timestamp">${timeAgo(createdAt)}</div>
    `;

    // Clicking or pressing Enter marks as read
    item.addEventListener("click", () => markAsRead(id));
    item.addEventListener("keypress", (e) => {
        if (e.key === "Enter") markAsRead(id);
    });

    document.getElementById("notifList").appendChild(item);
}



/* LOAD NOTIFICATIONS â€”> ONLY UNSEEN COUNT WILL SHOW */
async function loadNotifications() {
    try {
        const res = await fetch("/notifications/load/");
        const { notifications = [] } = await res.json();

        const notifList = document.getElementById("notifList");
        const notifCount = document.getElementById("notifCount");

        notifList.innerHTML = "";

        // Count only unread notifications
        const unseen = notifications.filter(n => !n.read).length;

        // Show badge only if unseen > 0
        notifCount.textContent = unseen;
        notifCount.style.display = unseen > 0 ? "inline-block" : "none";

        // Render all notifications
        notifications.forEach(renderNotification);

    } catch (err) {
        console.error("Error loading notifications:", err);
    }
}



/* MARK A SINGLE NOTIFICATION AS READ */
async function markAsRead(id) {
    try {
        await fetch("/notifications/read/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id })
        });

        // Reload after marking
        loadNotifications();

    } catch (err) {
        console.error("Error marking as read:", err);
    }
}



/* TOGGLE PANEL OPEN / CLOSE WITH ANIMATION */
const notifBtn = document.getElementById("notifBtn");
const notifPanel = document.getElementById("notifPanel");

notifBtn.addEventListener("click", () => {
    const isOpen = notifPanel.classList.contains("open");

    if (isOpen) {
        notifPanel.classList.remove("open");
        notifPanel.style.display = "none";
    } else {
        notifPanel.style.display = "block";

        // Delay to allow CSS animation
        setTimeout(() => {
            notifPanel.classList.add("open");
        }, 10);

        loadNotifications();
        trapFocus(notifPanel);
    }
});


// Close when clicking outside
document.addEventListener("click", (e) => {
    if (!notifPanel.contains(e.target) && !notifBtn.contains(e.target)) {
        notifPanel.classList.remove("open");
        notifPanel.style.display = "none";
    }
});



/* TRAP FOCUS INSIDE PANEL FOR KEYBOARD USERS */
function trapFocus(panel) {

    const focusable = panel.querySelectorAll("[tabindex]");
    if (!focusable.length) return;

    const first = focusable[0];
    const last = focusable[focusable.length - 1];

    panel.addEventListener("keydown", (e) => {
        if (e.key !== "Tab") return;

        // SHIFT + TAB â†’ loop focus to last
        if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
        }
        // TAB â†’ loop focus to first
        else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
        }
    });

    // Set focus inside panel
    first.focus();
}



/* INITIAL LOAD */

document.addEventListener("DOMContentLoaded", loadNotifications);

</script>
