{% extends 'dashboard.html' %}
{% load static %}

{% block title %}Assigned Tasks{% endblock %}
{% block extra_css %}
<!-- Inline styles removed - using global CSS from mystyle.css -->
{% endblock %}
{% block content %}
<div class="container-fluid">
  <h1>See Assigned Tasks</h1>

<!-- Search Filter -->
<form id="filterForm" class="row g-3 mb-4">
    <div class="col-md-3">
        <select name="filter_type" class="form-control" id="filterType">
            <option value="title">Task Title</option>
            <option value="group">Group Name</option>
            <option value="status">Status</option>
            <option value="created_at">Created Date</option>
        </select>
    </div>

    <div class="col-md-4">
        <input type="text" name="filter_value" class="form-control"
               id="filterValue" placeholder="Enter search value">
    </div>

    <div class="col-md-1">
        <button type="button" class="btn btn-warning w-100" id="clearBtn">Clear</button>
    </div>
</form>

<!-- Main Table (Only One) -->
<div class="table-responsive">
    <table class="table table-striped table-bordered mt-3">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Assigned Group</th>
            <th>Status</th>
            <th>Created At</th>
            <th>Rejection Reason</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody id="taskResults">
            {% include "task_search_result.html" with tasks=tasks %}
        </tbody>
    </table>
</div>
<br>
    <br>

    <h1>See Subtask Assigned </h1>

    <!-- Search Filter -->
    <form class="row g-3 mb-3">
    <div class="col-md-3">
        <select id="subFilterType" class="form-control">
            <option value="title">Task Title</option>
            <option value="member">Member Name</option>
            <option value="status">Status</option>
        </select>
    </div>

    <div class="col-md-4">
        <input type="text" id="subFilterValue" class="form-control"
               placeholder="Enter search value">
    </div>

    <div class="col-md-2">
        <button type="button" id="subClearBtn" class="btn btn-warning w-100">Clear</button>
    </div>
</form>

<!--  Subtask table  -->
<table class="table table-striped table-bordered mt-3">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Assigned Member</th>
        <th>Status</th>
        <th>Created At</th>
        <th>Updated At</th>
        <th>Action</th>
      </tr>
    </thead>

    <tbody id="subtaskResults">
        {% include "subtask_search_result.html" with sub_tasks=sub_tasks %}
    </tbody>

</table>

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/myjs_script.js' %}"></script>


<script>
    // script for searching main task of leader direct assigned by admin
function activateClickableRows() {
    document.querySelectorAll(".clickable-row").forEach(row => {
        row.addEventListener("click", function () {
            window.location = this.dataset.href;
        });
    });
}
activateClickableRows();

let typingTimer;
let delay = 30;

// Fetch via AJAX
function fetchResults() {
    let type = document.getElementById("filterType").value;
    let value = document.getElementById("filterValue").value;

    fetch(`/task_search_result/?filter_type=${type}&filter_value=${value}`)
        .then(res => res.text())
        .then(html => {
            document.getElementById("taskResults").innerHTML = html;
            activateClickableRows();
        });
}

document.getElementById("filterValue").addEventListener("keyup", function () {
    clearTimeout(typingTimer);
    typingTimer = setTimeout(fetchResults, delay);
});

document.getElementById("filterType").addEventListener("change", fetchResults);

document.getElementById("clearBtn").addEventListener("click", function () {
    document.getElementById("filterValue").value = "";
    fetchResults();
});
</script>


<script>
    // script for searching for subtask data
let subTimer;
let subDelay = 300;

function fetchSubtaskResults() {
    let type = document.getElementById("subFilterType").value;
    let value = document.getElementById("subFilterValue").value;

    fetch(`/subtask_search_result/?filter_type=${type}&filter_value=${value}`)
        .then(res => res.text())
        .then(html => {
            document.getElementById("subtaskResults").innerHTML = html;
            activateClickableRows();
        });
}

document.getElementById("subFilterValue").addEventListener("keyup", function () {
    clearTimeout(subTimer);
    subTimer = setTimeout(fetchSubtaskResults, subDelay);
});

document.getElementById("subFilterType").addEventListener("change", fetchSubtaskResults);

document.getElementById("subClearBtn").addEventListener("click", function () {
    document.getElementById("subFilterValue").value = "";
    fetchSubtaskResults();
});
</script>
{% endblock %}
